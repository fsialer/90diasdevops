jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'  # ğŸš€ Cache automÃ¡tico
        
    - name: ğŸ“¦ Install dependencies
      run: npm ci  # MÃ¡s rÃ¡pido que npm install
      
    - name: ğŸ§ª Run tests
      run: npm test -- --ci --coverage --watchAll=false
      
    - name: ğŸ“Š Upload coverage
      uses: actions/upload-artifact@v4
      with:
        name: coverage-reports
        path: coverage/

  build:
    runs-on: ubuntu-latest
    needs: test  # Solo si tests pasan
    steps:
    - uses: actions/checkout@v4
    
    - uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - run: npm ci
    
    - name: ğŸ—ï¸ Build application
      run: npm run build
      
    - name: ğŸ“¦ Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-files
        path: dist/

  build-docker:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: ğŸ³ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: ğŸ” Login to registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
        
    - name: ğŸ—ï¸ Build and push
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./s10/d64/Dockerfile.optimized
        push: true
        tags: ghcr.io/${{ github.repository }}:${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        platforms: linux/amd64,linux/arm64

  # ğŸš€ Jobs en paralelo para diferentes ambientes
  deploy-staging:
    needs: build
    if: github.ref == 'refs/heads/develop'
    runs-on: ubuntu-latest
    steps:
    - name: ğŸš€ Deploy to staging
      run: echo "Deploying to staging..."
      
  deploy-prod:
    needs: build  
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    environment: production
    steps:
    - name: ğŸš€ Deploy to production
      run: echo "Deploying to production..."