name: ğŸ­ Deploy a PRODUCCION

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Â¿Confirmas el deploy a PRODUCCIÃ“N? (escribe: SI)'
        required: true
        default: 'NO'

jobs:
  deploy-production:
    name: Desplegar a ProducciÃ³n
    runs-on: mi-runners
    if: github.event.inputs.confirm == 'SI'
    
    steps:
    - name: Checkout cÃ³digo
      uses: actions/checkout@v4

    - name: Setup kubectl
      run: |
        curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
        chmod +x kubectl
        sudo mv kubectl /usr/local/bin/
    - name: Cache
      uses: actions/cache@v4.3.0
      with:
        # A list of files, directories, and wildcard patterns to cache and restore
        path: "dd"
      
    - name: ConfirmaciÃ³n de producciÃ³n
      run: |
        echo "ğŸš¨ DESPLEGANDO A PRODUCCIÃ“N ğŸš¨"
        echo "Rama: ${{ github.ref_name }}"
        echo "Commit: ${{ github.sha }}"
        
    - name: Backup actual
      run: |
        echo "ğŸ’¾ Creando backup..."
        kubectl get deployment mi-app -n prod -o yml > backup-prod.yml 2>/dev/null || echo "No hay deployment previo"
        
    - name: Desplegar a producciÃ³n
      run: |
        echo "ğŸ­ Desplegando a PRODUCCIÃ“N..."
        kubectl apply -f k8s/prod/app-prod.yml
        
    - name: Esperar deployment
      run: |
        kubectl rollout status deployment/mi-app -n prod --timeout=600s
        
    - name: Verificar resultado
      run: |
        echo "âœ… Estado final en PRODUCCIÃ“N:"
        kubectl get pods -n prod -o wide
        kubectl get service -n prod
        echo "ğŸŒ Accesible en: http://localhost:30003"
        
    - name: Test de producciÃ³n
      run: |
        echo "ğŸ§ª Test final de producciÃ³n..."
        kubectl run test-prod --image=curlimages/curl --rm -i --restart=Never -- \
          curl -s http://mi-app-service.prod.svc.cluster.local || echo "Test completado"
        
    - name: Rollback si algo falla
      if: failure()
      run: |
        echo "ğŸ”™ Â¡Algo fallÃ³! Haciendo rollback..."
        if [ -f backup-prod.yml ]; then
          kubectl apply -f backup-prod.yml
          echo "âœ… Rollback desde backup completado"
        else
          kubectl rollout undo deployment/mi-app -n prod
          echo "âœ… Rollback automÃ¡tico completado"
        fi
