name: ğŸ“Š Pipeline Metrics

on:
  schedule:
    - cron: '0 9 * * *'  # Diario a las 9 AM
  workflow_dispatch:

jobs:
  metrics:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: ğŸ“¦ Install dependencies
      run: pip install requests
      
    - name: ğŸ“Š Generate metrics
      run: python scripts/generate-metrics.py
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GITHUB_REPOSITORY: ${{ github.repository }}
        
    - name: ğŸ“ˆ Create simple dashboard
      run: |
        cat > dashboard.html << 'EOF'
        <!DOCTYPE html>
        <html>
        <head>
            <title>ğŸ“Š Pipeline Dashboard</title>
            <style>
                body { font-family: Arial; margin: 40px; background: #f5f5f5; }
                .metric { background: white; padding: 20px; margin: 10px; border-radius: 8px; display: inline-block; }
                .success { border-left: 5px solid #4CAF50; }
                .warning { border-left: 5px solid #FF9800; }
                .error { border-left: 5px solid #f44336; }
                .big-number { font-size: 2em; font-weight: bold; }
            </style>
        </head>
        <body>
            <h1>ğŸš€ Pipeline Dashboard</h1>
            <div id="metrics"></div>
            
            <script>
                fetch('pipeline-metrics.json')
                    .then(response => response.json())
                    .then(data => {
                        const container = document.getElementById('metrics');
                        
                        container.innerHTML = `
                            <div class="metric success">
                                <h3>âœ… Tasa de Ã‰xito</h3>
                                <div class="big-number">${data.success_rate}%</div>
                            </div>
                            
                            <div class="metric ${data.avg_duration_minutes > 10 ? 'warning' : 'success'}">
                                <h3>â±ï¸ Tiempo Promedio</h3>
                                <div class="big-number">${data.avg_duration_minutes}min</div>
                            </div>
                            
                            <div class="metric">
                                <h3>ğŸš€ Total Ejecuciones</h3>
                                <div class="big-number">${data.total_runs}</div>
                            </div>
                            
                            <div class="metric">
                                <h3>ğŸ“… Ãšltima ActualizaciÃ³n</h3>
                                <div>${new Date(data.updated).toLocaleString()}</div>
                            </div>
                        `;
                    });
            </script>
        </body>
        </html>
        EOF
        
    - name: ğŸ“¤ Deploy dashboard
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: .
        include_files: |
          dashboard.html
          pipeline-metrics.json