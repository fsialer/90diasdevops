name: ğŸ§ª Tests + Deploy a DEV

on:
  push:
    branches: [d38_develop]
  workflow_dispatch:

jobs:
  test-and-deploy:
    name: Tests y Deploy Seguro
    runs-on: mi-runners
    
    steps:
    - name: Checkout cÃ³digo
      uses: actions/checkout@v4
      
    - name: ğŸ§ª Ejecutar tests bÃ¡sicos
      run: |
        echo "ğŸ§ª Verificando que tenemos kubectl..."
        kubectl version --client
        
        echo "ğŸ” Verificando cluster..."
        kubectl get nodes
        
        echo "âœ… Tests de infraestructura pasaron"
        
    - name: ğŸ› ï¸ Deploy con health checks
      run: |
        echo "ğŸ› ï¸ Desplegando con health checks..."
        kubectl apply -f s6/d38/k8s/dev/app-dev.yml
        
    - name: â³ Esperar deployment seguro
      run: |
        echo "â³ Esperando que el deployment sea exitoso..."
        kubectl rollout status deployment/mi-app -n dev --timeout=300s
        
        echo "ï¿½ Verificando que los pods estÃ©n READY..."
        kubectl get pods -n dev -l app=mi-app
        
        # Esperar que al menos 1 pod estÃ© ready
        kubectl wait --for=condition=ready pod -l app=mi-app -n dev --timeout=120s
        
    - name: ğŸ§ª Tests de conectividad
      run: |
        echo "ğŸ§ª Probando conectividad interna..."
        
        # Test dentro del cluster
        kubectl run test-pod --image=curlimages/curl --rm -i --restart=Never -- \
          curl -f http://mi-app-service.dev.svc.cluster.local --max-time 10 || true
          
        # Verificar que el service responde
        kubectl get service -n dev mi-app-service
        
        echo "âœ… Tests de conectividad completados"
        
    - name: ğŸ“Š Estado final
      run: |
        echo "ğŸ“Š Estado final del deployment:"
        kubectl get deployment -n dev mi-app -o wide
        kubectl get pods -n dev -l app=mi-app -o wide
        echo ""
        echo "ğŸŒ AplicaciÃ³n accesible en:"
        echo "   NodePort: http://localhost:30001"
        echo "   Port-forward: kubectl port-forward -n dev svc/mi-app-service 8001:80"
        
    - name: ğŸš¨ Rollback si algo fallÃ³
      if: failure()
      run: |
        echo "ğŸš¨ Â¡Algo fallÃ³! Ejecutando rollback..."
        kubectl rollout undo deployment/mi-app -n dev || echo "No hay versiÃ³n previa"
        echo "ğŸ”™ Rollback completado"